<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>I think ... - Caddyfile</title><link href="https://blog.kmonsoor.com/" rel="alternate"></link><link href="https://blog.kmonsoor.com/tag/caddyfile/feed/atom/index.html" rel="self"></link><id>https://blog.kmonsoor.com/</id><updated>2021-04-16T00:00:00+06:00</updated><entry><title>Personal short-link server using onlyÂ Caddyserver</title><link href="https://blog.kmonsoor.com/personal-shortlink-server-using-Caddy/" rel="alternate"></link><published>2021-04-16T00:00:00+06:00</published><updated>2021-04-16T00:00:00+06:00</updated><author><name>Khaled Monsoor</name></author><id>tag:blog.kmonsoor.com,2021-04-16:/personal-shortlink-server-using-Caddy/</id><summary type="html">&lt;p&gt;Yeah, there are tons of open-source, full-fledged link-shorteners. But, none were exactly what I wanted. Hence, the minimal approach only utilizing the amazing webserver, &lt;code&gt;Caddy&lt;/code&gt;. Here we go&amp;nbsp;&amp;hellip;&lt;/p&gt;</summary><content type="html">&lt;p&gt;Before I go into any details, please note that I&amp;rsquo;ve used the term &amp;ldquo;shortlink-server&amp;rdquo; instead of &amp;ldquo;url-shortener&amp;rdquo; because the difference is significant for this post. 
A url-shortener takes a long url, and gives a short url, then redirects any requests for the shortened link to its long counterpart. On the contrary, shortlink-server takes both the long and short url, then only does the redirect-ion&amp;nbsp;part.&lt;/p&gt;
&lt;h2 id="backstory"&gt;Backstory&lt;a class="headerlink" href="#backstory" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;If I wanted an amazing, personal url-shortener or &amp;ldquo;go link&amp;rdquo; server, there are many amazing solutions out there, which are not only free or open-source but full-fledged as well for personal or public usage. Rather, I wanted some &amp;ldquo;service&amp;rdquo; that will &amp;ldquo;resolve&amp;rdquo; my personal, short links. I have been using bit.ly for a long time for its customizable &amp;ldquo;short-half&amp;rdquo; part, but the problem with bit.ly is &amp;ndash; for some God-forsaken reason &amp;ndash; blocked by the Bangladeshi govt. So, I needed a replacement to be properly &amp;ldquo;glocal&amp;rdquo;.
There are many free (unbranded) and commercial (branded) options as well, but I wanted something that will be resolved via my hosted service (and personal domain) and as cheap as possible. So, basically solution for a poor nerd&amp;nbsp;:D&lt;/p&gt;
&lt;p&gt;Before jumped into this solution, I tried (deployed &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; tested) few others myself, mainly &lt;a href="https://github.com/kellegous/go"&gt;kellegous/go&lt;/a&gt;, &lt;a href="kutt.it"&gt;kutt.it&lt;/a&gt; and &lt;a href="https://github.com/adamyi/golinks"&gt;adamyi/golinks&lt;/a&gt;. But, all of them &amp;ldquo;too featureful&amp;rdquo; for my&amp;nbsp;needs. &lt;/p&gt;
&lt;p&gt;&lt;img alt="Simple, on-prem short-link server using Caddy webserver" src="https://i.imgur.com/4nZbnUE.png"&gt;&lt;/p&gt;
&lt;p&gt;What I wanted is to be able&amp;nbsp;to:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;resolve only my custom shortlinks (hence, no need for&amp;nbsp;url-shortener)&lt;/li&gt;
&lt;li&gt;not a public, internet-facing service (hence, any frontend, authentication, email verification etc. would be overkill&amp;nbsp;)&lt;/li&gt;
&lt;li&gt;minimal setup (if possible, no webapp at&amp;nbsp;all)&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Given my previous experience with &lt;code&gt;Caddy&lt;/code&gt; webserver, which is an amazing one(&lt;a href="https://caddyserver.com/docs/"&gt;why?&lt;/a&gt;), I had a gut feeling that Caddy has something for me &amp;ndash; under the sleeve &amp;ndash; to meet my minimal set of requirements. Thankfully, I managed to find&amp;nbsp;it.&lt;/p&gt;
&lt;p&gt;I believe &lt;span class="caps"&gt;NGINX&lt;/span&gt;, currently the most popular webserver, has some kind of similar mechanism as well. But, I&amp;rsquo;m not an expert, and once I was genuinely intimidated by its config file syntax. &lt;span class="caps"&gt;YMMV&lt;/span&gt;.&lt;/p&gt;
&lt;h2 id="what-you-gonna-need"&gt;What you gonna need?&lt;a class="headerlink" href="#what-you-gonna-need" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;your own domain which will be the root of the shortlinks. While sub-domained &lt;span class="caps"&gt;URL&lt;/span&gt; like &lt;code&gt;go.yourname.com/*&lt;/code&gt; is quite common, if you have some short domain, like you.co/*, only for this purpose, that&amp;rsquo;s fine as&amp;nbsp;well.&lt;/li&gt;
&lt;li&gt;A webhost server or public-facing instance with its own, &lt;strong&gt;public&lt;/strong&gt; IPv4&amp;nbsp;address.&lt;/li&gt;
&lt;li&gt;working knowledge of&amp;nbsp;Linux&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="step-1-point-your-subdomain-to-the-right-place"&gt;Step-1: Point your subdomain to the right place&lt;a class="headerlink" href="#step-1-point-your-subdomain-to-the-right-place" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;Find out what&amp;rsquo;s the &lt;strong&gt;puplic IPv4 address&lt;/strong&gt; of your instance that&amp;rsquo;ll act as the webserver. It&amp;rsquo;s usually on the cloud management dashboard.&lt;ul&gt;
&lt;li&gt;make sure that, regardless of your cloud architecture (e.g. &lt;span class="caps"&gt;VPC&lt;/span&gt;, subnet, firewall etc.), the &lt;span class="caps"&gt;SSL&lt;/span&gt; port (&lt;code&gt;:443&lt;/code&gt;) of the instance is reachable from the public&amp;nbsp;internet.&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;now go to your domain name registrar (or, &lt;span class="caps"&gt;DNS&lt;/span&gt; management provider which in my case is Cloudflare). There, you need to point shortlink subdomain (&lt;code&gt;go.&lt;/code&gt;)to the webserver&amp;rsquo;s &lt;span class="caps"&gt;IP&lt;/span&gt;&amp;nbsp;address.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Actually, you can do this step at the last. But for some reason, I prefer it to do first. Because sometimes, &lt;a href="https://blog.cloudflare.com/never-deal-with-dns-propagation-again/"&gt;&lt;span class="caps"&gt;DNS&lt;/span&gt; propagation&lt;/a&gt; takes some time. But, once my webservice is up and running, I like to see the result instantaneously.&amp;nbsp;;)&lt;/p&gt;
&lt;h2 id="step-2-install-caddy-the-mighty-webserver"&gt;Step-2: Install Caddy, the mighty webserver&lt;a class="headerlink" href="#step-2-install-caddy-the-mighty-webserver" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Depending on your host &lt;span class="caps"&gt;OS&lt;/span&gt; (mine is Ubuntu 20.04 &lt;span class="caps"&gt;LTS&lt;/span&gt;), you need to install the &lt;code&gt;Caddy&lt;/code&gt; webserver. While there are some hacky solutions to run, I think running Caddy as a background server is the simplest to manage.
In fact, the documentation of Caddy is excellent, I&amp;rsquo;d better leave that part to&amp;nbsp;you. &lt;/p&gt;
&lt;p&gt;After running with the default config(&lt;code&gt;Caddyfile&lt;/code&gt;) which is in Ubuntu&amp;rsquo;s case located as &lt;code&gt;/etc/caddy/Caddyfile&lt;/code&gt;, it should have a status somewhat like the below image. Please note that, in many cases, if running without &lt;code&gt;sudo&lt;/code&gt; Caddy cannot attach itself with the &lt;span class="caps"&gt;SSL&lt;/span&gt; port (&lt;code&gt;:443&lt;/code&gt;) which is necessary for serving &lt;code&gt;https://&lt;/code&gt;.  So, check for that error message in the &amp;ldquo;status&amp;rdquo;&amp;nbsp;log.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Caddy service on Ubuntu" src="https://i.imgur.com/cfS5nvZ.png?1"&gt;&lt;/p&gt;
&lt;p&gt;&lt;em&gt;&lt;strong&gt;&lt;span class="caps"&gt;P.S.&lt;/span&gt;&lt;/strong&gt; By the way, want your console and command prompt to look ðŸš€ like mine? Here&amp;rsquo;s the guide: &lt;a href="https://blog.kmonsoor.com/pimp-up-my-terminal/"&gt;How do I pimp up my terminal on&amp;nbsp;Linux&lt;/a&gt;&lt;/em&gt;&lt;/p&gt;
&lt;h2 id="step-3-tell-caddy-your-short-links-to-redirect"&gt;Step-3: Tell Caddy your short-links to redirect&lt;a class="headerlink" href="#step-3-tell-caddy-your-short-links-to-redirect" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Now, it&amp;rsquo;s time to configure Caddy to actually do the&amp;nbsp;job.&lt;/p&gt;
&lt;p&gt;Caddy has its native &lt;code&gt;redir&lt;/code&gt; &lt;span class="dquo"&gt;&amp;ldquo;&lt;/span&gt;directive&amp;rdquo; to redirect incoming web-request from one to another. While the &lt;code&gt;map&lt;/code&gt; directive is relatively new, it makes the config file i.e. Caddyfile look elegant in case you have (or, will have in the long run) a long list of&amp;nbsp;short-links.&lt;/p&gt;
&lt;p&gt;Here&amp;rsquo;s mine which is working&amp;nbsp;&amp;hellip;  &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="linenos" data-linenos=" 1 "&gt;&lt;/span&gt;# /etc/caddy/Caddyfile
&lt;span class="linenos" data-linenos=" 2 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos=" 3 "&gt;&lt;/span&gt;go.kmonsoor.com {   # replace it your web-url root
&lt;span class="linenos" data-linenos=" 4 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos=" 5 "&gt;&lt;/span&gt;    map {path} {redirect-uri} {
&lt;span class="linenos" data-linenos=" 6 "&gt;&lt;/span&gt;        /blog    https://blog.kmonsoor.com
&lt;span class="linenos" data-linenos=" 7 "&gt;&lt;/span&gt;        /photos  https://photos.kmonsoor.com
&lt;span class="linenos" data-linenos=" 8 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos=" 9 "&gt;&lt;/span&gt;        /resume     https://drive.google.com/file/d/1nMS3i1ai6nsI70zZ7NFnNQ_XmvAa4GOl
&lt;span class="linenos" data-linenos="10 "&gt;&lt;/span&gt;        /resume-doc https://docs.google.com/document/d/1ECx1Yr8Jzz9I3S5VcoKnZQz56oIht2XaM5gSNetcWag
&lt;span class="linenos" data-linenos="11 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="12 "&gt;&lt;/span&gt;        /rickrolled    https://www.youtube.com/watch?v=dQw4w9WgXcQ
&lt;span class="linenos" data-linenos="13 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="14 "&gt;&lt;/span&gt;        # will add new ones here like the above
&lt;span class="linenos" data-linenos="15 "&gt;&lt;/span&gt;        # ...
&lt;span class="linenos" data-linenos="16 "&gt;&lt;/span&gt;    }
&lt;span class="linenos" data-linenos="17 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="18 "&gt;&lt;/span&gt;    # this below code is required to actually make the above `map` work
&lt;span class="linenos" data-linenos="19 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="20 "&gt;&lt;/span&gt;    @hasRedir expression `{redirect-uri} != &amp;quot;&amp;quot;`
&lt;span class="linenos" data-linenos="21 "&gt;&lt;/span&gt;    redir @hasRedir {redirect-uri}
&lt;span class="linenos" data-linenos="22 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="23 "&gt;&lt;/span&gt;    # code below is to set the default response if the requested shortlink isn&amp;#39;t here
&lt;span class="linenos" data-linenos="24 "&gt;&lt;/span&gt;    respond &amp;quot;Thas&amp;#39;s an unknown short URL ... :(&amp;quot;  
&lt;span class="linenos" data-linenos="25 "&gt;&lt;/span&gt;}
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Note: Don&amp;rsquo;t forget to restart the &lt;code&gt;caddy&lt;/code&gt; service to let the new config to take&amp;nbsp;effect.&lt;/p&gt;
&lt;h2 id="step-4-profit"&gt;Step-4: Profit !&lt;a class="headerlink" href="#step-4-profit" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;Yeah, that&amp;rsquo;s it. Now, add some own personal stuff with some cool short-links, and proudly share with the&amp;nbsp;world.&lt;/p&gt;
&lt;h2 id="whats-next"&gt;What&amp;rsquo;s next ?&lt;a class="headerlink" href="#whats-next" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;I&amp;rsquo;m thinking that given the very low workload my shortlink resolver needs â€” unless I&amp;rsquo;m becoming an overnight internet sensation â€” using a server instance only for this purpose is overkill. My next goal is to have the same service using some &amp;ldquo;serverless&amp;rdquo; function or using the &amp;ldquo;&lt;a href="https://developers.cloudflare.com/workers/examples/redirect"&gt;worker on the edge&lt;/a&gt;&amp;rdquo; thing from Cloudflare. Let&amp;rsquo;s see&amp;nbsp;;)&lt;/p&gt;</content><category term="Tech"></category><category term="caddyserver"></category><category term="url-shortener"></category><category term="Caddyfile"></category><category term="web-link"></category></entry></feed>