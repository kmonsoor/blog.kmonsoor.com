<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>I think ... - database</title><link href="https://blog.kmonsoor.com/" rel="alternate"></link><link href="https://blog.kmonsoor.com/tag/database/feed/atom/index.html" rel="self"></link><id>https://blog.kmonsoor.com/</id><updated>2018-01-18T00:00:00+06:00</updated><entry><title>HA(High-Availability) Setup for InfluxDB</title><link href="https://blog.kmonsoor.com/ha-setup-for-influxdb/" rel="alternate"></link><published>2018-01-18T00:00:00+06:00</published><updated>2018-01-18T00:00:00+06:00</updated><author><name>Khaled Monsoor</name></author><id>tag:blog.kmonsoor.com,2018-01-18:/ha-setup-for-influxdb/</id><summary type="html">&lt;p&gt;Create a robust, highly-available, time-series InfluxDB cluster with the community(free) version of&amp;nbsp;it&lt;/p&gt;</summary><content type="html">&lt;p&gt;&lt;strong&gt;&lt;span class="caps"&gt;NOTE&lt;/span&gt;&lt;/strong&gt;
&lt;em&gt;Since I have written this article, all the components used in this below architecture have gone through many updates and releases. While the general premise involving &lt;code&gt;influxdb-relay&lt;/code&gt; and the multiplexing might still hold, please sync up with the latest release docs before jumping into some serious system&amp;nbsp;design.&lt;/em&gt;&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Currently, from version 0.9, you cannot create an InfluxDB cluster from the open-sourced free edition. Only commercially available InfluxDB Enterprise can do that for now. That stirred up the early-adopter enthusiast users, especially for their usage in professional setups. They complained that InfluxData, the company behind InfluxDB, is trying to milk the &lt;span class="caps"&gt;OSS&lt;/span&gt; solution for&amp;nbsp;profit.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Archiving isn't easy ... tobias-fischer-PkbZahEG2Ng" src="https://i.imgur.com/0IdYOYnl.jpg"&gt;&lt;/p&gt;
&lt;p&gt;I can&amp;rsquo;t blame the InfluxData guys much, as they got to pay their bills too. So far, we — the users of open-source systems — couldn&amp;rsquo;t show much promise about the financial realities of the projects. Continuing development of &lt;span class="caps"&gt;OSS&lt;/span&gt; products, by only depending on donations, patrons, or enterprise sponsorship, is far too rare and unpredictable, even for the projects that many successful organizations heavily rely&amp;nbsp;on.&lt;/p&gt;
&lt;p&gt;Anyways, InfluxDB then promised and later introduced &lt;code&gt;Influx Relay&lt;/code&gt; as a complimentary consolation for missing &lt;span class="caps"&gt;HA&lt;/span&gt; parts of InfluxDB. You can get the details here and here about&amp;nbsp;that. &lt;/p&gt;
&lt;h2 id="premise"&gt;Premise&lt;a class="headerlink" href="#premise" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;p&gt;For my needs, I have to try to create a reliable &lt;span class="caps"&gt;HA&lt;/span&gt;(High-Availability) setup from available free options, hence InfluxDB and the relay. It&amp;rsquo;s quite a bit far from an InfluxDB-cluster in terms of robustness or ease of setup, but it&amp;rsquo;s got the job done, at least for&amp;nbsp;me.&lt;/p&gt;
&lt;p&gt;I needed a setup to receive system-stats from at least 500+ instances and to store them for a while, but without breaking the bank in bills from &lt;span class="caps"&gt;AWS&lt;/span&gt;. Meaning, I could ask for and could use only couple of instances for my&amp;nbsp;solution.&lt;/p&gt;
&lt;p&gt;Here were my&amp;nbsp;trade-offs.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;Not too many instances for this purpose. Neither, any of the heavyweight lifters e.g. &lt;span class="caps"&gt;AWS&lt;/span&gt;&amp;rsquo; m3-xlarge etc. To use only what&amp;rsquo;s&amp;nbsp;necessary. &lt;/li&gt;
&lt;li&gt;To satisfy the budget, hence avoiding pay-per-use solutions as far as it is&amp;nbsp;possible.&lt;/li&gt;
&lt;li&gt;Solutions must not be crazy complex, so that handover to the DevOps team be&amp;nbsp;smooth.&lt;/li&gt;
&lt;li&gt;Reading the data would be too rarely w.r.t. writing. The related Grafana dashboards will be only used to investigate issues by a handful of&amp;nbsp;people.&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id="overall-design"&gt;Overall Design&lt;a class="headerlink" href="#overall-design" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h2&gt;
&lt;h3 id="write"&gt;Write&lt;a class="headerlink" href="#write" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;From a birds&amp;rsquo; eye view, I decided to use two server instances to run parallelly, hosting InfluxDB on them independently and then sending the same data over to them for storing. This scheme mostly looks like &lt;a href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_1"&gt;&lt;span class="caps"&gt;RAID&lt;/span&gt;-1 systems&lt;/a&gt;.&lt;/p&gt;
&lt;p&gt;&lt;img alt="Overall architecture" src="https://i.imgur.com/ZKYIyOd.png"&gt;&lt;/p&gt;
&lt;p&gt;That brings up a couple of&amp;nbsp;challenges.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;None of the agents I used on the sender side could multiplex output. That means, they were able to send data to a single destination, not multiple. 
    On the Windows front, I&amp;rsquo;ve used &lt;code&gt;Telegraf&lt;/code&gt; which is able randomly to switch between pre-listed destinations, but &lt;span class="caps"&gt;NOT&lt;/span&gt; multiple at-once.&lt;br&gt;
    In the case of Linux hosts, I used &lt;code&gt;Netdata&lt;/code&gt; which is excellent in its own right, but unable to send stats to multiple destinations.&lt;br&gt;
  Here comes &lt;code&gt;Influx-relay&lt;/code&gt;. It can receive time-series data-stream from hosts on a &lt;span class="caps"&gt;TCP&lt;/span&gt; or &lt;span class="caps"&gt;UDP&lt;/span&gt; port, buffer for a while, and then re-send those received and buffered data to multiple receive ends which can either be an InfluxDB instance or another listening Influx-relay instances.&lt;br&gt;
  This chaining can broaden the relaying scheme even further. However, for my purpose, this relay-chaining was not necessary. Rather, from the relay, I am sending data to the separate InfluxDB instances, running on two separate&amp;nbsp;instances.  &lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;Now that I partially multiplexed the output, my hosts (senders) still are able to send to one destination. So, I need a proxy as well as a load-balancer. For a while, I was torn between &lt;span class="caps"&gt;NGINX&lt;/span&gt; and HAProxy. Both were new to&amp;nbsp;me.  &lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;However, for a couple of reasons, I went for HAProxy.  Firstly, I don&amp;rsquo;t need &lt;span class="caps"&gt;HTTP&lt;/span&gt; session management. Secondly, as I wanted to keep my &lt;span class="caps"&gt;UDP&lt;/span&gt; for later, HAProxy was perfectly capable of that.&lt;br&gt;
  &lt;span class="caps"&gt;NGINX&lt;/span&gt; has the support recently, but the maturity was a concern. Also, configuring &lt;span class="caps"&gt;NGINX&lt;/span&gt; seems a little intimidating (which I know might not be so true). Last but not least, and for what it&amp;rsquo;s worth, out-of-the-box, HAProxy&amp;rsquo;s stat page carries much more in-depth information than that of free-version of &lt;span class="caps"&gt;NGINX&lt;/span&gt;.&lt;br&gt;
  Upon receiving the stats stream, HAProxy was supposed to send that to different Influx-relays in a load-balanced&amp;nbsp;fashion.&lt;/p&gt;
&lt;p&gt;So, here&amp;rsquo;s my rough&amp;nbsp;plan. &lt;/p&gt;
&lt;p&gt;collector-agent &amp;rarr; HAProxy &amp;rarr; (50/50 load-balanced) &amp;rarr; Influx-relay &amp;rarr; (multiplexed)  &amp;rarr;  2 InfluxDB&amp;nbsp;instances&lt;/p&gt;
&lt;p&gt;Now, each one of the received data is to go to both of the InfluxDB instances, or at least to one in case of failure (or, overload per se) of any the relays or Influx instances.  
Also, I have chosen to keep Influx-relays deployed as Dockerized and kept HAProxy and InfluxDB instances running as native services. Of course, you can Dockerize HAProxy and InfluxDB,&amp;nbsp;too.  &lt;/p&gt;
&lt;h3 id="read"&gt;Read&lt;a class="headerlink" href="#read" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;As I&amp;rsquo;ve already noted in the section that reading the data, meaning to fetch data to visualize on Grafana end, will happen rarely and sporadically; only to investigate alarms or any other client-side performance&amp;nbsp;issues.  &lt;/p&gt;
&lt;p&gt;So, the read requests, reaching the HAProxy end, needed not much routing, other than directly to InfluxDB itself. Still, to better distribute the load I decided to load-balance it 50/50&amp;nbsp;basis.&lt;/p&gt;
&lt;h3 id="ports"&gt;Ports&lt;a class="headerlink" href="#ports" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;ul&gt;
&lt;li&gt;As all the &lt;span class="caps"&gt;READ&lt;/span&gt; requests are routed through &lt;code&gt;HAProxy&lt;/code&gt; running on each of the instances, to the external world only HAProxy&amp;rsquo;s port should be opened for this&amp;nbsp;purpose. &lt;/li&gt;
&lt;li&gt;On the other hand, for &lt;span class="caps"&gt;WRITE&lt;/span&gt; requests, InfluxDBs are receiving data from relays, one of its own instance and another one on other instance, so InfluxDB should listen on its own port for &lt;span class="caps"&gt;WRITE&lt;/span&gt; requests only. But, this must be accessible only from own &lt;span class="caps"&gt;VPS&lt;/span&gt; zone, but not open to the outside&amp;nbsp;world.&lt;/li&gt;
&lt;li&gt;In case of HAProxy as well as InfluxDB, you can use the default ports, obviously, which is 8086 &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; 8088 respectively. Or, you can choose to go for other ports (security through obfuscation). Your call. In this writing, I&amp;rsquo;ll go with the&amp;nbsp;defaults.&lt;/li&gt;
&lt;/ul&gt;
&lt;h3 id="authentication-ssl"&gt;Authentication, &lt;span class="caps"&gt;SSL&lt;/span&gt;&lt;a class="headerlink" href="#authentication-ssl" title="Permanent link"&gt;&amp;para;&lt;/a&gt;&lt;/h3&gt;
&lt;p&gt;You can configure &lt;span class="caps"&gt;SSL&lt;/span&gt; with your own server certificates through the HAProxy configs. You can even go for &lt;span class="caps"&gt;SSL&lt;/span&gt; from the relays to InfluxDB writes. If your sender hosts are connecting to your HAProxy through public internet, you should at least go for password-based authentication, better to utilize &lt;span class="caps"&gt;SSL&lt;/span&gt;. However, for brevity&amp;rsquo;s sake, I&amp;rsquo;ll skip them in this&amp;nbsp;post.&lt;/p&gt;
&lt;p&gt;**Note: *
Please bear in mind, this is an &amp;ldquo;in-progress&amp;rdquo; post; prematurely published to force me to work on it. I have the plan to add all the necessary configurations &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; commands, that I used,&amp;nbsp;here.&lt;/p&gt;</content><category term="Tech"></category><category term="Linux"></category><category term="influxdb"></category><category term="influx-relay"></category><category term="haproxy"></category><category term="monitoring"></category><category term="computing"></category><category term="time-series"></category><category term="database"></category><category term="open-source"></category><category term="reliability"></category><category term="architecture"></category></entry><entry><title>Generate ER diagram from a SQL-based database</title><link href="https://blog.kmonsoor.com/generate-er-diagram-from-sql-database/" rel="alternate"></link><published>2014-12-18T00:00:00+06:00</published><updated>2014-12-18T00:00:00+06:00</updated><author><name>Khaled Monsoor</name></author><id>tag:blog.kmonsoor.com,2014-12-18:/generate-er-diagram-from-sql-database/</id><summary type="html">&lt;p&gt;When you are &amp;ldquo;study&amp;rdquo;-ing someone else&amp;rsquo;s database with 300+ tables. It&amp;rsquo;s like spaghetti, but not enjoyable. Rather,&amp;nbsp;horrific.&lt;/p&gt;</summary><content type="html">&lt;p&gt;When you are &amp;ldquo;study&amp;rdquo;-ing (for whatever reason) someone else&amp;rsquo;s database, and the database has more than 20 tables, you might be in trouble to understand what&amp;rsquo;s going&amp;nbsp;where.&lt;/p&gt;
&lt;p&gt;Now, imagine a database with 300+ tables. It&amp;rsquo;s like spaghetti, just not as&amp;nbsp;enjoyable.&lt;/p&gt;
&lt;p&gt;I faced a similar challenge recently with a database of 250+ tables. Yes, I felt like in a deep sh*t. And, I started looking for tools that can describe the tables, or at least a decent &lt;span class="caps"&gt;ER&lt;/span&gt; diagram. If anything more, better. And, preferably&amp;nbsp;free.&lt;/p&gt;
&lt;p&gt;Then, I found &lt;a href="http://schemaspy.sourceforge.net/"&gt;SchemaSpy&lt;/a&gt;, originally authored by &lt;a href="https://sites.google.com/site/johncurrier/"&gt;John Currier&lt;/a&gt;. It generates a complete in-depth &lt;span class="caps"&gt;HTML&lt;/span&gt;-based description (of course, including clickable &lt;span class="caps"&gt;ER&lt;/span&gt;-diagram) of the database, which you can then browse with your browser. This post is about its primary&amp;nbsp;usage.&lt;/p&gt;
&lt;p&gt;The output will be kind of like this:
&lt;img alt="schemapy output sample" src="https://i.imgur.com/K1yYBID.png"&gt;&lt;/p&gt;
&lt;p&gt;It is based on Java, but it can work its magic on most of the major database products. However, it would require an appropriate &lt;span class="caps"&gt;JDBC&lt;/span&gt; connector for that&amp;nbsp;database.&lt;/p&gt;
&lt;p&gt;Quote from the&amp;nbsp;author:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;&lt;code&gt;SchemaSpy&lt;/code&gt; uses &lt;span class="caps"&gt;JDBC&lt;/span&gt;&amp;rsquo;s database metadata extraction services to gather the majority of its information but has to make vendor-specific &lt;span class="caps"&gt;SQL&lt;/span&gt; queries to gather some information such as the &lt;span class="caps"&gt;SQL&lt;/span&gt; associated with a view and the details of check&amp;nbsp;constraints.&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;In this post, as an example, I have shown how to use it with PostgreSQL. But, it&amp;rsquo;s not the only one that&amp;rsquo;s supported. You can use it with any proper &lt;span class="caps"&gt;RDBMS&lt;/span&gt; system as long as it has a &lt;span class="caps"&gt;JDBC&lt;/span&gt;-connector.
 Now, to use it, you need to get these&amp;nbsp;stuffs.&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;strong&gt;First of all&lt;/strong&gt;, your system should have &lt;strong&gt;Java runtime&lt;/strong&gt; properly installed. &lt;a href="https://adoptopenjdk.net/"&gt;Download from&amp;nbsp;here.&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;SchemaSpy, which is a .jar file&lt;/strong&gt;. &lt;a href="https://sourceforge.net/projects/schemaspy/files/"&gt;Get it here&lt;/a&gt;.
    At the time of writing, it was version&amp;nbsp;5.0.0.&lt;/li&gt;
&lt;li&gt;&lt;strong&gt;&lt;span class="caps"&gt;JDBC&lt;/span&gt; connector to PostgreSQL&lt;/strong&gt;. Make sure to match your PostgreSQL version. You can &lt;a href="https://jdbc.postgresql.org/download.html"&gt;download it from here&lt;/a&gt;.&lt;br&gt;
    You can check your PostgreSQL version by executing: &lt;code&gt;SELECT version();&lt;/code&gt; query on &lt;strong&gt;&lt;em&gt;psql&lt;/em&gt;&lt;/strong&gt;&amp;nbsp;prompt.&lt;/li&gt;
&lt;li&gt;Also, SchemaSpy depends on &lt;strong&gt;GarphViz&lt;/strong&gt; to generate the &lt;span class="caps"&gt;ER&lt;/span&gt; diagrams, so you need to be installed it on your system. Get it from here.(&lt;a href="http://www.graphviz.org/Download..php"&gt;http://www.graphviz.org/Download..php&lt;/a&gt;)&lt;/li&gt;
&lt;li&gt;And, of course, make sure the target database instance is running &lt;span class="amp"&gt;&amp;amp;&lt;/span&gt; serving the database you are trying to&amp;nbsp;visualize.&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;Quoting from the&amp;nbsp;author:&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;SchemaSpy uses the dot executable from &lt;a href="http://www.graphviz.org/"&gt;Graphviz&lt;/a&gt; to generate graphical representations of the table/view relationships. The visual representation of the connections is a fundamental feature of the&amp;nbsp;tool.  &lt;/p&gt;
&lt;p&gt;Graphviz is not required to view the output generated by SchemaSpy, but &lt;strong&gt;the dot program should be in your &lt;span class="caps"&gt;PATH&lt;/span&gt;&lt;/strong&gt; (not &lt;span class="caps"&gt;CLASSPATH&lt;/span&gt;) when running SchemaSpy, or none of the entity-relationship diagrams will be generated. Or, maybe &lt;a href="http://schemaspy.sourceforge.net/#gvparam"&gt;use the &lt;code&gt;-gv&lt;/code&gt;&lt;/a&gt;&amp;nbsp;option).&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;I kept the .jar files (both the &lt;span class="caps"&gt;JDBC&lt;/span&gt;-connector and the &lt;code&gt;SchemaSpy&lt;/code&gt;) in my home folder for convenience.&lt;br&gt;
Now, in my case, my &lt;span class="caps"&gt;OS&lt;/span&gt; is Linux, and the database is hosted locally; hence address is &lt;code&gt;127.0.0.1&lt;/code&gt;, running &lt;code&gt;PostgreSQL-9.3&lt;/code&gt; at port &lt;code&gt;5432&lt;/code&gt;.
So, I run the command like&amp;nbsp;this:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="linenos" data-linenos="1 "&gt;&lt;/span&gt; $ java -jar ./schemaSpy_5.0.0.jar -t pgsql -host 127.0.0.1:5432 -db your_database_name \
&lt;span class="linenos" data-linenos="2 "&gt;&lt;/span&gt;                                   -u your_DB_user_name -p your_password -s public \
&lt;span class="linenos" data-linenos="3 "&gt;&lt;/span&gt;                                   -dp ./postgresql-9.3-1102.jdbc3.jar \
&lt;span class="linenos" data-linenos="4 "&gt;&lt;/span&gt;                                   -o output_folder
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;It may take a little while, depending on the size of the schema of the database.&lt;br&gt;
After that, you will find the output folder/directory named &lt;code&gt;output_folder&lt;/code&gt;.&lt;br&gt;
You&amp;rsquo;ll see some output when the magic is going on, similar to this&amp;nbsp;below.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;code&gt;&lt;span class="linenos" data-linenos="1 "&gt;&lt;/span&gt;Using database properties: [./schemaSpy_5.0.0.jar]/net/sourceforge/schemaspy/dbTypes/pgsql.properties
&lt;span class="linenos" data-linenos="2 "&gt;&lt;/span&gt;Gathering schema details....................(6sec)
&lt;span class="linenos" data-linenos="3 "&gt;&lt;/span&gt;Writing/graphing summary....................(2sec)
&lt;span class="linenos" data-linenos="4 "&gt;&lt;/span&gt;Writing/diagramming detail..................(31sec)
&lt;span class="linenos" data-linenos="5 "&gt;&lt;/span&gt;Wrote relationship details of 113 tables/views to directory &amp;#39;output&amp;#39; in 41 seconds.
&lt;span class="linenos" data-linenos="6 "&gt;&lt;/span&gt;
&lt;span class="linenos" data-linenos="7 "&gt;&lt;/span&gt;View the results by opening output_folder/index.html
&lt;/code&gt;&lt;/pre&gt;&lt;/div&gt;
&lt;p&gt;Now, all the generated files are in the &lt;code&gt;output_folder&lt;/code&gt;.
Start your journey by starting from the &lt;code&gt;index.html&lt;/code&gt; in the output folder. Open it by using any&amp;nbsp;browser.&lt;/p&gt;
&lt;p&gt;Good luck.&amp;nbsp;:)&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;If you find this post helpful, you can show your support &lt;a href="https://www.patreon.com/kmonsoor"&gt;through Patreon&lt;/a&gt; or by &lt;a href="https://ko-fi.com/kmonsoor"&gt;buying me a coffee&lt;/a&gt;. &lt;em&gt;Thanks!&lt;/em&gt;&lt;/p&gt;</content><category term="Tech"></category><category term="database"></category><category term="sql"></category><category term="dbms"></category><category term="ER-diagram"></category><category term="graphviz"></category><category term="java"></category><category term="postgresql"></category><category term="programming"></category><category term="RDBMS"></category><category term="schema"></category><category term="schemaspy"></category><category term="visualization"></category></entry></feed>