<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="canonical" href="https://blog.kmonsoor.com/ha-setup-for-influxdb/"><title>HA(High-Availability) Setup for InfluxDB -- Khaled Monsoor :: Blog</title><meta name="robots" content="nofollow"><meta name="author" content="Khaled Monsoor"><link rel="image_src" href="https://blog.kmonsoor.com/favicon.ico"><meta property="og:image" content="https://blog.kmonsoor.com/favicon.ico"><meta name="description" content="Create a robust, highly-available, time-series InfluxDB cluster with community(free) version of it"><meta property="og:site_name" content="Khaled Monsoor :: Blog"><meta property="og:type" content="article"><meta property="og:locale" content="en_US"><meta property="og:title" content="HA(High-Availability) Setup for InfluxDB -- Khaled Monsoor :: Blog"><meta property="og:url" content="https://blog.kmonsoor.com/ha-setup-for-influxdb/"><meta property="og:description" content="Create a robust, highly-available, time-series InfluxDB cluster with community(free) version of it"><meta property="article:published_time" content="2018-01-18 00:00:00+06:00"><meta name="twitter:site" content="@kmonsoor"><meta name="twitter:creator" content="@kmonsoor"><meta name="twitter:image" content="https://pbs.twimg.com/profile_images/681426835092029440/ZxuFAKOY_400x400.png"><meta name="twitter:card" content="Create a robust, highly-available, time-series InfluxDB cluster with community(free) version of it"><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.4/jquery.min.js"></script><script defer src="https://blog.kmonsoor.com/theme/js/application.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/css/bootstrap.min.css"><link rel="stylesheet" href="https://blog.kmonsoor.com/theme/css/all.css"><link rel="icon" href="https://blog.kmonsoor.com/favicon.ico" type="image/x-icon"><link rel="shortcut icon" href="https://blog.kmonsoor.com/favicon.ico" type="image/x-icon"><script> window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;ga('create','UA-20431143-1','auto');ga('send','pageview');</script><script async src="https://www.google-analytics.com/analytics.js"></script><link href="https://blog.kmonsoor.com/feed/atom/index.html" type="application/atom+xml" rel="alternate" title="Khaled Monsoor :: Blog - Latest posts - Atom Feed"><link href="https://blog.kmonsoor.com/feed/index.html" type="application/rss+xml" rel="alternate" title="Khaled Monsoor :: Blog - Latest posts - RSS Feed"><link href="https://blog.kmonsoor.com/category/tech/feed/atom/index.html" type="application/atom+xml" rel="alternate" title="Khaled Monsoor :: Blog - Category: Tech - Atom Feed"><link href="https://blog.kmonsoor.com/category/tech/feed/index.html" type="application/rss+xml" rel="alternate" title="Khaled Monsoor :: Blog - Category: Tech - RSS Feed"></head><body><div class="container"><div class="page-header"><a href="https://blog.kmonsoor.com" class="avatar-container pull-left"><div class="avatar "><div class="side"><img src="/logo.png" class="img-responsive"></div></div></a><h1><a href="https://blog.kmonsoor.com">Khaled Monsoor :: Blog</a><small></small></h1></div><nav class="navbar navbar-default"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#plumage-navbar-collapse-1" aria-expanded="false"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a class="navbar-brand" href="https://blog.kmonsoor.com" title>HA(High-Availability) Setup for InfluxDB</a></div><div class="collapse navbar-collapse" id="plumage-navbar-collapse-1"><ul class="nav navbar-nav"><li><a href="/">Home</a></li><li><a href="https://blog.kmonsoor.com/about/">About Me</a></li><li><a href="https://blog.kmonsoor.com/category/language/">Language</a></li><li class="active"><a href="https://blog.kmonsoor.com/category/tech/">Tech <span class="sr-only">(current)</span></a></li><li><a href="https://blog.kmonsoor.com/category/thoughts/">Thoughts</a></li></ul></div></nav></div><div class="container main"><div class="row"><div class=" col-md-9  "><h1><a href="https://blog.kmonsoor.com/ha-setup-for-influxdb/" rel="bookmark" title="Permalink to HA(High-Availability) Setup for InfluxDB">HA(High-Availability) Setup for InfluxDB</a></h1></div></div><div class="row"><div class=" col-md-9 " id="content" role="main"><div><h1>HA setup for InfluxDB</h1><p>Currently, from version 0.9, you cannot create an InfluxDB cluster from the open-sourced free edition. Only commercially available InfluxDB Enterprise can do that for now. That stirred up the early-adopter enthusiast users, especially for their usage in professional setups. They complained that InfluxData, the company behind InfluxDB, is trying to milk the OSS solution for profit.</p><p>I can't blame InfluxData guys much, as they gotta pay their bills too. So far, we the users of OSS systems couldn't show much promise about commercial realities of the projects. Bearing OSS future only depending on donations, patrons or enterprise sponsorship is far too rare and unpredictable, even for the projects that many successful organizations heavily rely on.</p><p>Anyways, InfluxDB then promised and later introduced <code>Influx Relay</code> as a complimentary consolation for missing HA parts of InfluxDB. You can get the details here and here about that. </p><h2>Premise</h2><p>For my needs, I have to try to create a reliable HA(High-Availability) setup from available free options, hence InfluxDB and the relay. It's definitely far from an InfluxDB-cluster in terms of robustness or ease of setup, but it's got the job done, at least for me.</p><p>I needed a setup to receive system-stats from at least 500+ instances and to store them for a while, but without breaking the bank in bills from AWS. Meaning, I could ask for and could use only couple of instances for my solution.</p><p>Here were my trade-offs.</p><ul><li>Not too many instances for this purpose. Neither, any of the heavyweight lifters e.g. AWS' m3-xlarge etc. To use only what's necessary. </li><li>To satisfy the budget, hence avoiding pay-per-use solutions as far as it is possible.</li><li>Solutions must not be crazy complex, so that handover to the DevOps team be smooth.</li><li>Reading the data would be too rarely w.r.t. writing. The related Grafana dashboards will be only used to investigate issues by a handful of people.</li></ul><h2>Overall Design</h2><h3>Write</h3><p>From a birds' eye view, I decided to use two instances to run parallelly, hosting InfluxDB on them independently and then send exactly same data over to them for storing. This scheme mostly looks like <a href="https://en.wikipedia.org/wiki/Standard_RAID_levels#RAID_1">RAID-1 systems</a>.</p><p><img alt="Overall architecture" src="https://i.imgur.com/ZKYIyOd.png"></p><p>That brings up a couple of challenges.</p><ul><li><p>None of the agents I used on the sender side could multiplex output. Meaning, they were able to send data to a single destination, not multiple. On the Windows front, I've used <code>Telegraf</code> which is able randomly to switch between pre-listed destinations, but NOT multiple at-once.<br> In the case of Linux hosts, I used <code>Netdata</code> which is excellent in its own right, but unable to send stats to multiple destinations.<br> Here comes <code>Influx-relay</code>. It can receive time-series data-stream from hosts on a TCP or UDP port, buffer for a while, and then re-send those received and buffered data to multiple receive ends which can either be an InfluxDB instance or another listening Influx-relay instances.<br> This chaining can broaden the relaying scheme even further. However, for my purpose, this relay-chaining was not necessary. Rather, from the relay, I am sending data to the separate InfluxDB instances, running on two separate instances. </p></li><li><p>Now that I partially multiplexed the output, my hosts (senders) still are able to send to one destination. So, I need a proxy as well as a load-balancer. For a while, I was torn between NGINX and HAProxy. Both were new to me. </p></li></ul><p>However, for a couple of reasons, I went for HAProxy. Firstly, I have no need for HTTP session management. Secondly, as I wanted to keep my UDP for later, HAProxy was perfectly capable of that.<br> NGINX has the support recently, maturity was a concern. Also, configuring NGINX seems little intimating (which I know not so true). Last but not least, and for what its worth, out-of-the-box, HAProxy's stat page carries much more in-depth information than that of free-version of NGINX.<br> Upon receiving the stats stream, HAProxy was supposed to send that to different Influx-relays in a load-balanced fashion.</p><p>So, here's my rough plan. </p><div class="highlight"><pre><span></span>collector-agent --&gt; HAProxy --&gt; (50/50 load-balanced) --&gt; Influx-relay --&gt; (multiplexed)  --&gt;  2 InfluxDB instances
</pre></div><p>Now, each of the received data is to go to both the InfluxDB, or at least one in case of failure (or, overload) of any the relays or Influx instances. Â  Also, I have chosen to keep Influx-relays deployed as Dockerized and kept HAProxy and InfluxDB instances running as native services. Of course, you can Dockerize HAProxy and InfluxDB, too. </p><h3>Read</h3><p>As I've already noted in the section that reading the data, meaning to fetch data to visualize on Grafana end, will happen rarely and sporadically; only to investigate alarms or any other client-side performance issues. </p><p>So, the read requests, reaching the HAProxy end, needed not much routing, other than directly to InfluxDB itself. Still, to better distribute the load I decided to load-balance it 50/50 basis.</p><h3>Ports</h3><ul><li>As all the READ requests are routed through <code>HAProxy</code> running on each of the instances, to the external world only HAProxy's port should be opened for this purpose. </li><li>On the other hand, for WRITE requests, InfluxDBs are receiving data from relays, one of its own instance and another one on other instance, so InfluxDB should listen on its own port for WRITE requests only. But, this must be accessible only from own VPS zone, but not open to the outside world.</li><li>In case of HAProxy as well as InfluxDB, you can use the default ports, obviously, which is 8086 &amp; 8088 respectively. Or, you can choose to go for other ports (security through obfuscation). Your call. In this writing, I'll go with the defaults.</li></ul><h3>Authentication, SSL</h3><p>You can configure SSL with your own server certificates through the HAProxy configs. You can even go for SSL from the relays to InfluxDB writes. If your sender hosts are connecting to your HAProxy through public internet, you should at least go for password-based authentication, better to utilize SSL. However, for brevity's sake, I'll skip them in this post.</p><p><strong> Note: </strong> Please bear in mind, this is an "in-progress" post; prematurely published to force me to work on it. I have the plan to add all the necessary configurations &amp; commands, that I used, here.</p></div></div><div class="col-md-3"><div class="well"><p><abbr title="2018-01-18T00:00:00+06:00"><i class="fa fa-calendar"></i> Jan. 18, 2018</abbr></p><hr><p><a href="https://blog.kmonsoor.com/category/tech/" rel="tag" data-toggle="tooltip" class="label label-info" title="22 articles in this category">Tech</a><a href="/tag/computing/" data-toggle="tooltip" class="label label-default" title="2 articles with this tag">computing</a><a href="/tag/open-source/" data-toggle="tooltip" class="label label-default" title="2 articles with this tag">open-source</a><a href="/tag/influxdb/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">influxdb</a><a href="/tag/influx-relay/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">influx-relay</a><a href="/tag/haproxy/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">haproxy</a><a href="/tag/monitoring/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">monitoring</a><a href="/tag/time-series/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">time-series</a><a href="/tag/database/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">database</a><a href="/tag/reliability/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">reliability</a><a href="/tag/architecture/" data-toggle="tooltip" class="label label-default" title="1 article with this tag">architecture</a></p><hr><p>Found a typo ? Want to fix it ?</p><a class="btn btn-info btn-block" href="https://github.com/kmonsoor/blog.kmonsoor.com/edit/live/content/articles/ha-setup-for-influxdb.md"><i class="fa fa-random fa-white fa-fw"></i> Suggest edit on GitHub</a><hr></div></div></div></div><footer class="container"><div class="commentbox"></div></footer><footer class="container-fluid"><div class="container"><div class="row"><div class="col-md-2"><h5>Social</h5><ul class="list-unstyled"><li><a href="https://twitter.com/kmonsoor"><i class="fa fa-twitter"></i> @KhaledMonsoor </a></li><li><a href="http://instagram.com/kmonsoor/"><img src="https://icons.better-idea.org/icon?url=instagram.com&size=16" width="16" height="16" class="icon" alt="instagram.com icon"> kmonsoor </a></li></ul></div><div class="col-md-2"><h5>Professional</h5><ul class="list-unstyled"><li><a href="https://stackoverflow.com/story/kmonsoor"><i class="fa fa-stack-overflow"></i> Careers 2.0 </a></li><li><a href="https://linkedin.com/in/kmonsoor"><i class="fa fa-linkedin-square"></i> LinkedIn </a></li><li><a href="https://github.com/kmonsoor/"><i class="fa fa-github"></i> Github </a></li></ul></div><div class="col-md-2"><h5>Browse content by</h5><ul class="list-unstyled"><li><a href="https://blog.kmonsoor.com/categories/index.html"><i class="fa fa-tags"></i> Categories</a></li><li><a href="https://blog.kmonsoor.com/archives/index.html"><i class="fa fa-calendar"></i> Dates</a></li><li><a href="https://blog.kmonsoor.com/tags/index.html"><i class="fa fa-tag"></i> Tags</a></li></ul></div><div class="col-md-2"><h4><a target="_blank" href="https://paypal.me/kmonsoor/">Support Author</a></h4></div><div class="col-md-2 text-muted"><h5>Copyright notice</h5><p>Â© Copyright 2010-2020 Khaled Monsoor.</p></div><div class="col-md-2 text-muted"><h5>Disclaimer</h5><p>All opinions expressed in this site are my own personal opinions and are not endorsed by, nor do they represent the opinions of my previous, current and future employers or any of its affiliates, partners or customers.</p></div><div class="span2"><h5 class="pull-right"><a href="#" class="fa fa-arrow-up"> Back to top</a></h5></div></div></div><div class="container"><div class="row span12 muted text-center"> Site generated by <a href="http://getpelican.com"> Pelican</a> with modified <a href="https://github.com/kdeldycke/plumage">Plumage</a> theme. </div></div></footer><script src="https://unpkg.com/commentbox.io/dist/commentBox.min.js"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.6/js/bootstrap.min.js"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/jquery.magnific-popup.min.js"></script><script defer src="https://cdnjs.cloudflare.com/ajax/libs/fitvids/1.1.0/jquery.fitvids.min.js"></script><script defer src="https://blog.kmonsoor.com/theme/js/jquery.mglass.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/magnific-popup.js/1.1.0/magnific-popup.min.css"><script>
    commentBox('5722781509484544-proj');
</script></body></html>